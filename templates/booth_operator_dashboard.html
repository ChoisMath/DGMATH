<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>부스 운영자 대시보드</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container neon-box">
        <h2 class="neon-text">부스 운영자 대시보드</h2>
        
        <!-- 운영자 정보 표시 -->
        <div id="operatorInfo" class="neon-info">
            <p><strong>동아리명:</strong> <span id="clubName"></span></p>
            <p><strong>부스 주제:</strong> <span id="boothTopic"></span></p>
            <p><strong>학교:</strong> <span id="school"></span></p>
        </div>
        
        <!-- 메뉴 -->
        <div class="admin-menu">
            <button class="neon-btn" onclick="showSection('booth-management')">부스 관리</button>
            <button class="neon-btn" onclick="showSection('queue-management')">대기열 관리</button>
            <button class="neon-btn" onclick="showSection('my-booths')">내 부스 목록</button>
            <button class="neon-btn" onclick="logout()">로그아웃</button>
        </div>
        
        <!-- 부스 관리 섹션 -->
        <div id="booth-management" class="section" style="display: none;">
            <h3 style="color: #00ffe7;">부스 관리</h3>
            
            <div class="neon-info">
                <h4>새 부스 생성</h4>
                <form id="createBoothForm">
                    <label>부스 이름 <input type="text" id="booth_name" required></label><br>
                    <label>운영 장소 <input type="text" id="booth_location" required></label><br>
                    <label>간단한 설명 <textarea id="booth_description" rows="3" required></textarea></label><br>
                    <label>PDF 파일 <input type="file" id="booth_pdf" accept=".pdf"></label><br>
                    <button type="submit" class="neon-btn">부스 생성</button>
                </form>
            </div>
        </div>
        
        <!-- 대기열 관리 섹션 -->
        <div id="queue-management" class="section" style="display: none;">
            <h3 style="color: #00ffe7;">대기열 관리</h3>
            
            <div class="neon-info">
                <label>부스 선택 
                    <select id="boothSelect">
                        <option value="">부스를 선택하세요</option>
                    </select>
                </label>
                <button type="button" class="neon-btn" onclick="loadQueue()">대기열 조회</button>
            </div>
            
            <div id="queueList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- 내 부스 목록 섹션 -->
        <div id="my-booths" class="section" style="display: none;">
            <h3 style="color: #00ffe7;">내 부스 목록</h3>
            <div id="myBoothsList"></div>
        </div>
    </div>
    
    <script>
        let currentOperator = null;
        
        // 페이지 로드시 운영자 정보 확인
        document.addEventListener('DOMContentLoaded', function() {
            const operatorInfo = sessionStorage.getItem('boothOperatorInfo');
            if (!operatorInfo) {
                alert('로그인이 필요합니다.');
                window.location.href = '/booth-operator-login';
                return;
            }
            
            currentOperator = JSON.parse(operatorInfo);
            
            // 운영자 정보 표시
            document.getElementById('clubName').textContent = currentOperator.club_name;
            document.getElementById('boothTopic').textContent = currentOperator.booth_topic;
            document.getElementById('school').textContent = currentOperator.school;
            
            // 초기 섹션 표시
            showSection('booth-management');
            
            // 부스 목록 로드
            loadMyBooths();
        });
        
        // 섹션 표시
        function showSection(sectionId) {
            // 모든 섹션 숨기기
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // 선택된 섹션 표시
            document.getElementById(sectionId).style.display = 'block';
            
            if (sectionId === 'queue-management') {
                loadBoothsForQueue();
            } else if (sectionId === 'my-booths') {
                loadMyBooths();
            }
        }
        
        // 부스 생성
        document.getElementById('createBoothForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('booth_name').value);
            formData.append('location', document.getElementById('booth_location').value);
            formData.append('description', document.getElementById('booth_description').value);
            formData.append('operator_id', currentOperator.id);
            
            const pdfFile = document.getElementById('booth_pdf').files[0];
            if (pdfFile) {
                formData.append('pdf_file', pdfFile);
            }
            
            try {
                const response = await fetch('/api/create-booth', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert('부스가 성공적으로 생성되었습니다!');
                    document.getElementById('createBoothForm').reset();
                    loadMyBooths();
                } else {
                    alert('부스 생성 실패: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('부스 생성 중 오류가 발생했습니다.');
            }
        };
        
        // 대기열 관리용 부스 목록 로드
        async function loadBoothsForQueue() {
            try {
                const response = await fetch('/api/operator-booths', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operator_id: currentOperator.id
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    const select = document.getElementById('boothSelect');
                    select.innerHTML = '<option value="">부스를 선택하세요</option>';
                    
                    data.booths.forEach(booth => {
                        const option = document.createElement('option');
                        option.value = booth.id;
                        option.textContent = booth.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // 대기열 조회
        async function loadQueue() {
            const boothId = document.getElementById('boothSelect').value;
            if (!boothId) {
                alert('부스를 선택해주세요.');
                return;
            }
            
            try {
                const response = await fetch('/api/booth-queue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        booth_id: boothId
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    displayQueue(data.queue);
                } else {
                    alert('대기열 조회 실패: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('대기열 조회 중 오류가 발생했습니다.');
            }
        }
        
        // 대기열 표시
        function displayQueue(queue) {
            const queueList = document.getElementById('queueList');
            
            if (queue.length === 0) {
                queueList.innerHTML = '<div class="neon-info">대기 중인 학생이 없습니다.</div>';
                return;
            }
            
            let html = '<div class="neon-info"><h4>대기열 현황</h4>';
            
            queue.forEach((entry, index) => {
                const statusText = entry.status === 'waiting' ? '대기중' : 
                                 entry.status === 'called' ? '호출됨' : '완료';
                const statusColor = entry.status === 'waiting' ? '#00ffe7' : 
                                  entry.status === 'called' ? '#ffa500' : '#00ff00';
                
                html += `
                    <div style="border: 1px solid #00ffe744; padding: 10px; margin: 5px 0; border-radius: 5px;">
                        <p><strong>${index + 1}번.</strong> ${entry.student_name} (${entry.student_school})</p>
                        <p>상태: <span style="color: ${statusColor}">${statusText}</span></p>
                        <p>신청시간: ${new Date(entry.applied_at).toLocaleString()}</p>
                        ${entry.status === 'waiting' ? `
                            <button onclick="callStudent(${entry.id})" class="neon-btn" style="margin-right: 10px;">호출</button>
                            <button onclick="completeStudent(${entry.id})" class="neon-btn">완료</button>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            queueList.innerHTML = html;
        }
        
        // 학생 호출
        async function callStudent(entryId) {
            try {
                const response = await fetch('/api/call-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: entryId
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert('학생에게 호출 메시지가 발송되었습니다.');
                    loadQueue();
                } else {
                    alert('호출 실패: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('호출 중 오류가 발생했습니다.');
            }
        }
        
        // 학생 완료 처리
        async function completeStudent(entryId) {
            try {
                const response = await fetch('/api/complete-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: entryId
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert('학생이 완료 처리되었습니다.');
                    loadQueue();
                } else {
                    alert('완료 처리 실패: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('완료 처리 중 오류가 발생했습니다.');
            }
        }
        
        // 내 부스 목록 로드
        async function loadMyBooths() {
            try {
                const response = await fetch('/api/operator-booths', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operator_id: currentOperator.id
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    displayMyBooths(data.booths);
                } else {
                    document.getElementById('myBoothsList').innerHTML = '<div class="neon-info">부스 목록 조회 실패</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('myBoothsList').innerHTML = '<div class="neon-info">오류 발생</div>';
            }
        }
        
        // 내 부스 목록 표시
        function displayMyBooths(booths) {
            const myBoothsList = document.getElementById('myBoothsList');
            
            if (booths.length === 0) {
                myBoothsList.innerHTML = '<div class="neon-info">생성된 부스가 없습니다.</div>';
                return;
            }
            
            let html = '';
            booths.forEach(booth => {
                html += `
                    <div class="neon-info">
                        <h4>${booth.name}</h4>
                        <p><strong>장소:</strong> ${booth.location || '미설정'}</p>
                        <p><strong>설명:</strong> ${booth.description || '설명 없음'}</p>
                        <p><strong>생성일:</strong> ${new Date(booth.created_at).toLocaleString()}</p>
                        <div>
                            <button onclick="downloadQR('${booth.name}')" class="neon-btn">QR 코드 다운로드</button>
                            <button onclick="viewBoothDetails(${booth.id})" class="neon-btn">상세보기</button>
                        </div>
                    </div>
                `;
            });
            
            myBoothsList.innerHTML = html;
        }
        
        // QR 코드 다운로드
        function downloadQR(boothName) {
            window.open(`/admin/download-qr/${encodeURIComponent(boothName)}`, '_blank');
        }
        
        // 부스 상세보기
        function viewBoothDetails(boothId) {
            window.location.href = `/booth-operator/edit-booth/${boothId}`;
        }
        
        // 로그아웃
        function logout() {
            sessionStorage.removeItem('boothOperatorInfo');
            window.location.href = '/booth-operator-login';
        }
        
        // CSS 스타일 추가
        const style = document.createElement('style');
        style.textContent = `
            .section {
                margin-top: 20px;
                padding: 20px;
                border: 1px solid #00ffe744;
                border-radius: 8px;
                background: #181c2b;
            }
            
            .section h3 {
                margin-top: 0;
                margin-bottom: 15px;
            }
            
            .section form {
                margin-bottom: 20px;
            }
            
            .section label {
                display: block;
                margin-bottom: 10px;
                color: #fff;
            }
            
            .section input, .section textarea, .section select {
                width: 100%;
                padding: 8px;
                margin-top: 5px;
                border: 1px solid #00ffe7;
                border-radius: 4px;
                background: #23263a;
                color: #fff;
            }
            
            .section button {
                margin-top: 10px;
                margin-right: 10px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>